<!--
This partial generates version information for both the genome-portal and JBrowse which is displayed in the footer of each page.

Several environment variables are used to determine the type of build of the genome-portal and therefore control the footer.
Logic:
1. If the HUGO_PORTAL_VERSION is set:
    then the build is a production build and the version number is displayed.
2. If the HUGO_GIT_BRANCH is set to "main":
    then the build is from a GH action push to main (aka dev) and the commit sha is displayed with a link to the commit.
3. If the HUGO_GIT_BRANCH is set to another name than "main":
    then the build is a workflow dispatch from a feature branch and the commit sha and branch name will be displayed.
4. else:
    the build is a local build and the footer will display "Local dev build".
-->

{{ $githubURL := "https://github.com/ScilifelabDataCentre/genome-portal" }}
{{ $portalHref := "" }}
{{ $hrefText := "" }}

<!-- Extract all enviroment variables -->
{{ $gitRefName := getenv "CI_GIT_REF_NAME" }}
{{ $gitSha := getenv "CI_GIT_SHA" }}
{{ $gitShaShort := substr $gitSha 0 7 }}
{{ $jBrowseVersion := getenv "JBROWSE_VERSION" }}


<!-- Local build -->
{{ if eq (getenv "CI_EVENT_NAME") "local_build"}}
    {{ $portalHref = $githubURL }}
    {{ $hrefText = printf "%s@%s" $gitRefName $gitShaShort }}

<!-- Production build version -->
{{ else if eq (getenv "CI_EVENT_NAME") "release" }}
    {{ $portalHref = printf "%s/releases/tag/%s" $githubURL $gitRefName }}
    {{ $hrefText = $gitRefName }}
<!-- Workflow dispatch from a release branch -->
{{ else if hasPrefix $gitRefName "release-" }}
    {{ $version := strings.TrimPrefix "release-" $gitRefName }}
    {{ $portalHref = printf "%s/releases/tag/%s" $githubURL $version }}
    {{ $hrefText = $version }}
<!-- Push to main or manual dispatch from feature branch -->
{{ else }}
    {{ $portalHref = printf "%s/commit/%s" $githubURL $gitSha }}
    {{ $hrefText = printf "%s@%s" $gitRefName $gitShaShort }}
{{ end }}

<!-- Portal version info -->
<p class="mt-3 mt-xl-0 mb-0 text-start text-lg-center">
    <i> Website last updated: {{ now.Format "02 January 2006"}} </i>
    (<a href="{{ $portalHref }}" target="_blank" rel="noopener noreferrer">{{ $hrefText }}</a>)
</p>


<!-- Happens if site built using Hugo not docker -->
{{ if eq $jBrowseVersion "" }}
    {{ $jBrowseVersion = "X.X.X" }}
{{ end }}

{{ $jBrowseHref := printf "https://github.com/GMOD/jbrowse-components/releases/tag/v%s" $jBrowseVersion }}
<p class="mt-0 mb-3 text-start text-lg-center">
    <i> JBrowse version used:
        <a href="{{ $jBrowseHref }}" target="_blank" rel="noopener noreferrer">v{{ $jBrowseVersion }}</a>
    </i>
</p>
